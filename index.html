<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ¤œãƒã‚¹ã‚¿ãƒ¼ Pro - å®Œå…¨ç‰ˆ</title>
    <style>
        :root {
            --apple-blue: #007AFF;
            --apple-green: #34C759;
            --apple-red: #FF3B30;
            --apple-orange: #FF9500;
            --bg: #F2F2F7;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; min-height: 100vh; }
        .screen { width: 100%; max-width: 500px; display: none; background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; box-sizing: border-box; position: relative; }
        .active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* åˆ¤å®šã‚¢ã‚¤ã‚³ãƒ³ */
        #feedback-icon { font-size: 100px; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0; z-index: 100; transition: 0.2s; }
        .show-feedback { opacity: 0.9 !important; transform: translate(-50%, -50%) scale(1.2) !important; }

        .level-btn { padding: 15px; font-size: 18px; font-weight: bold; border-radius: 12px; border: 2px solid var(--apple-blue); background: white; color: var(--apple-blue); cursor: pointer; margin-bottom: 10px; width: 100%; transition: 0.2s; }
        .level-btn.selected { background: var(--apple-blue); color: white; }

        .timer-bar { width: 100%; height: 8px; background: #E5E5EA; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--apple-blue); width: 100%; }
        
        .q-text { font-size: 38px; font-weight: bold; margin-bottom: 20px; color: #1C1C1E; position: relative; }
        .options { display: grid; gap: 12px; }
        .opt-btn { padding: 18px; font-size: 18px; border: 2px solid #F2F2F7; border-radius: 15px; background: white; text-align: left; cursor: pointer; transition: 0.1s; }
        .correct { background: var(--apple-green) !important; color: white !important; border-color: var(--apple-green) !important; }
        .wrong { background: var(--apple-red) !important; color: white !important; border-color: var(--apple-red) !important; }

        .history-area { margin-top: 20px; text-align: left; background: #f9f9fb; padding: 15px; border-radius: 15px; font-size: 13px; border: 1px solid #eee; }
        .start-btn { background: var(--apple-blue); color: white; border: none; padding: 18px; border-radius: 30px; font-size: 20px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,122,255,0.3); }
        .badge { font-size: 14px; background: var(--apple-orange); color: white; padding: 2px 10px; border-radius: 10px; vertical-align: middle; margin-left: 10px; position: absolute; top: -20px; right: 0; }
        #combo-display { font-size: 24px; font-weight: bold; color: var(--apple-orange); margin-bottom: 10px; min-height: 30px; }
    </style>
</head>
<body>

    <div id="feedback-icon"></div>

    <div id="home-screen" class="screen active">
        <h1>è‹±æ¤œãƒã‚¹ã‚¿ãƒ¼ Pro</h1>
        <p style="color:#666;">AIãŒã‚ãªãŸã®å¼±ç‚¹ã‚’åˆ†æä¸­</p>
        <div id="levels">
            <button class="level-btn" onclick="selectLevel('3ç´š', this)">3ç´š</button>
            <button class="level-btn selected" onclick="selectLevel('æº–2ç´š', this)">æº–2ç´š</button>
            <button class="level-btn" onclick="selectLevel('2ç´š', this)">2ç´š</button>
        </div>
        <button class="start-btn" onclick="startQuiz()">å­¦ç¿’é–‹å§‹ï¼</button>
        <div class="history-area">
            <h3 style="margin:0 0 10px 0;">ğŸ“Š å­¦ç¿’å±¥æ­´</h3>
            <div id="history-list">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
        <div id="combo-display">0 COMBO</div>
        <div id="current-info" style="color:#8E8E93; margin-bottom:10px;"></div>
        <div class="timer-bar"><div class="timer-fill" id="timer"></div></div>
        <div class="q-text">
            <span id="q-word"></span>
            <span id="target-badge"></span>
        </div>
        <div class="options" id="options"></div>
        <button onclick="speak()" style="margin-top:25px; background:none; border:none; color:var(--apple-blue); font-size:18px; cursor:pointer; font-weight:bold;">ğŸ”Š å†ç”Ÿ</button>
    </div>

    <div id="result-screen" class="screen">
        <h1>çµæœç™ºè¡¨</h1>
        <h2 id="final-score" style="font-size: 45px; color: var(--apple-blue); margin: 10px 0;"></h2>
        <p id="max-combo-info" style="color:var(--apple-orange); font-weight:bold;"></p>
        <div id="mistake-list" style="text-align:left; background:#fff0f0; padding:15px; border-radius:15px; margin-top:20px; max-height:200px; overflow-y:auto;"></div>
        <button class="start-btn" onclick="goToHome()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    </div>

    <script>
        const dictionary = {
            "3ç´š": [
                {q: "Achieve", a: "é”æˆã™ã‚‹", d: ["æ¨ã¦ã‚‹", "å€Ÿã‚Šã‚‹", "é¿ã‘ã‚‹"]},
                {q: "Anxious", a: "å¿ƒé…ã—ã¦", d: ["é€€å±ˆãª", "å‹‡æ•¢ãª", "æº€è¶³ã—ãŸ"]},
                {q: "Believe", a: "ä¿¡ã˜ã‚‹", d: ["ç–‘ã†", "å¿˜ã‚Œã‚‹", "å£Šã™"]},
                {q: "Century", a: "1ä¸–ç´€", d: ["10å¹´é–“", "å­£ç¯€", "æ™‚ä»£"]},
                {q: "Decrease", a: "æ¸›å°‘ã™ã‚‹", d: ["å¢—åŠ ã™ã‚‹", "ç§»å‹•ã™ã‚‹", "å®‰å®šã™ã‚‹"]},
                {q: "Effort", a: "åŠªåŠ›", d: ["çµæœ", "æ‰èƒ½", "é‹"]},
                {q: "Foreign", a: "å¤–å›½ã®", d: ["åœ°å…ƒã®", "ç¾ä»£ã®", "å®‰å…¨ãª"]},
                {q: "Government", a: "æ”¿åºœ", d: ["ä¼šç¤¾", "å¸‚å ´", "å­¦æ ¡"]},
                {q: "Healthy", a: "å¥åº·ãª", d: ["å±é™ºãª", "é™ã‹ãª", "è£•ç¦ãª"]},
                {q: "Improve", a: "æ”¹å–„ã™ã‚‹", d: ["æ±šã™", "éš ã™", "æ­¢ã‚ã‚‹"]},
                {q: "Ancient", a: "å¤ä»£ã®", d: ["ç¾ä»£ã®", "æœªæ¥ã®", "æµè¡Œã®"]},
                {q: "Baggage", a: "æ‰‹è·ç‰©", d: ["ãƒã‚±ãƒƒãƒˆ", "åº§å¸­", "ãŠåœŸç”£"]},
                {q: "Climate", a: "æ°—å€™", d: ["å¤©æ°—", "æ¸©åº¦", "å­£ç¯€"]},
                {q: "Education", a: "æ•™è‚²", d: ["å¨¯æ¥½", "é‹å‹•", "ä»•äº‹"]},
                {q: "Journal", a: "é›‘èªŒãƒ»æ—¥è¨˜", d: ["è¾æ›¸", "æ‰‹ç´™", "æ•™ç§‘æ›¸"]},
                {q: "Medicine", a: "è–¬", d: ["é£Ÿäº‹", "ç¡çœ ", "é‹å‹•"]},
                {q: "Ordinary", a: "æ™®é€šã®", d: ["çã—ã„", "é«˜ä¾¡ãª", "æ–°ã—ã„"]},
                {q: "Reduce", a: "æ¸›ã‚‰ã™", d: ["å¢—ã‚„ã™", "é‹ã¶", "å®ˆã‚‹"]},
                {q: "Various", a: "æ§˜ã€…ãª", d: ["å˜ä¸€ã®", "é€€å±ˆãª", "åŒã˜"]},
                {q: "Knowledge", a: "çŸ¥è­˜", d: ["æƒ³åƒ", "å™‚", "è¨˜æ†¶"]}
            ],
            "æº–2ç´š": [
                {q: "Appropriate", a: "é©åˆ‡ãª", d: ["çªç„¶ã®", "æ­£ç¢ºãª", "è¤‡é›‘ãª"]},
                {q: "Describe", a: "æå†™ã™ã‚‹", d: ["ç ´å£Šã™ã‚‹", "ç„¡è¦–ã™ã‚‹", "äºˆç´„ã™ã‚‹"]},
                {q: "Opportunity", a: "æ©Ÿä¼š", d: ["åå¯¾", "çµè«–", "è²¬ä»»"]},
                {q: "Recognize", a: "èªã‚ã‚‹", d: ["ç„¡è¦–ã™ã‚‹", "æ‰¹åˆ¤ã™ã‚‹", "éš ã™"]},
                {q: "Contribute", a: "è²¢çŒ®ã™ã‚‹", d: ["æ¶ˆè²»ã™ã‚‹", "å®Œæˆã•ã›ã‚‹", "æ··ä¹±ã•ã›ã‚‹"]},
                {q: "Prevent", a: "é˜²ã", d: ["ä¿ƒé€²ã™ã‚‹", "è¨±ã™", "æº–å‚™ã™ã‚‹"]},
                {q: "Significant", a: "é‡è¦ãª", d: ["å€‹åˆ¥ã®", "ä¼çµ±çš„ãª", "ä¸€æ™‚çš„ãª"]},
                {q: "Resource", a: "è³‡æº", d: ["çµæœ", "è²¬ä»»", "ç†ç”±"]},
                {q: "Encourage", a: "åŠ±ã¾ã™", d: ["ç¦æ­¢ã™ã‚‹", "é©šã‹ã›ã‚‹", "è½èƒ†ã•ã›ã‚‹"]},
                {q: "Analyze", a: "åˆ†æã™ã‚‹", d: ["è€ãˆã‚‹", "å¼·èª¿ã™ã‚‹", "ç¶­æŒã™ã‚‹"]},
                {q: "Economy", a: "çµŒæ¸ˆ", d: ["ç”Ÿæ…‹", "æ•™è‚²", "é¸æŒ™"]},
                {q: "Specific", a: "ç‰¹å®šã®", d: ["ä¸€èˆ¬çš„ãª", "å·¨å¤§ãª", "æ›–æ˜§ãª"]},
                {q: "Candidate", a: "å€™è£œè€…", d: ["å½“é¸è€…", "è¦³å®¢", "å¯©åˆ¤"]},
                {q: "Facility", a: "æ–½è¨­ãƒ»è¨­å‚™", d: ["è‡ªç„¶", "é“å…·", "æ‰èƒ½"]},
                {q: "Gradually", a: "å¾ã€…ã«", d: ["çªç„¶", "ä¸€ç¬ã§", "æ°¸é ã«"]},
                {q: "Particular", a: "ç‰¹å®šã®", d: ["ä¸€èˆ¬çš„ãª", "æ™®é€šã®", "çã—ã„"]},
                {q: "Theory", a: "ç†è«–", d: ["å®Ÿè·µ", "äº‹å®Ÿ", "ç©ºæƒ³"]},
                {q: "Unique", a: "ç‹¬ç‰¹ãª", d: ["å…±é€šã®", "æ™®é€šã®", "å¤ã„"]},
                {q: "Vehicle", a: "ä¹—ã‚Šç‰©", d: ["å»ºç‰©", "é“", "é‹è»¢æ‰‹"]},
                {q: "Persuade", a: "èª¬å¾—ã™ã‚‹", d: ["å¼·åˆ¶ã™ã‚‹", "è­¦å‘Šã™ã‚‹", "ãŒã£ã‹ã‚Šã•ã›ã‚‹"]}
            ],
            "2ç´š": [
                {q: "Abolish", a: "å»ƒæ­¢ã™ã‚‹", d: ["è¨­ç«‹ã™ã‚‹", "ç¶­æŒã™ã‚‹", "æ”¹å–„ã™ã‚‹"]},
                {q: "Biological", a: "ç”Ÿç‰©å­¦çš„ãª", d: ["ç‰©ç†çš„ãª", "åŒ–å­¦çš„ãª", "å¿ƒç†çš„ãª"]},
                {q: "Counterfeit", a: "å½é€ ã®", d: ["æœ¬ç‰©ã®", "é«˜ä¾¡ãª", "å¤ã„"]},
                {q: "Deprive", a: "å¥ªã†", d: ["ä¸ãˆã‚‹", "æ•‘ã†", "è²¸ã™"]},
                {q: "Enthusiasm", a: "æƒ…ç†±", d: ["ç„¡é–¢å¿ƒ", "ææ€–", "æ€’ã‚Š"]},
                {q: "Fluctuate", a: "å¤‰å‹•ã™ã‚‹", d: ["å®‰å®šã™ã‚‹", "åœæ­¢ã™ã‚‹", "å¢—åŠ ã™ã‚‹"]},
                {q: "Guarantee", a: "ä¿è¨¼ã™ã‚‹", d: ["æ‹’å¦ã™ã‚‹", "ç–‘ã†", "ç„¡è¦–ã™ã‚‹"]},
                {q: "Hypothesis", a: "ä»®èª¬", d: ["çµè«–", "äº‹å®Ÿ", "è¨¼æ˜"]},
                {q: "Inevitably", a: "å¿…ç„¶çš„ã«", d: ["å¶ç„¶ã«", "ãŠãã‚‰ã", "ã¾ã‚Œã«"]},
                {q: "Legislation", a: "æ³•å¾‹", d: ["è¡Œæ”¿", "å¸æ³•", "é•å"]},
                {q: "Obsolete", a: "æ™‚ä»£é…ã‚Œã®", d: ["æœ€æ–°ã®", "ä¾¿åˆ©ãª", "é«˜ä¾¡ãª"]},
                {q: "Prejudice", a: "åè¦‹", d: ["å…¬å¹³", "ç†è§£", "æ­£ç¾©"]},
                {q: "Simultaneous", a: "åŒæ™‚ã®", d: ["åˆ¥ã€…ã®", "ä»¥å‰ã®", "é…ã‚ŒãŸ"]},
                {q: "Vulnerable", a: "è„†å¼±ãª", d: ["å¼·åŠ›ãª", "å®‰å…¨ãª", "ä¸å¤‰ã®"]},
                {q: "Agriculture", a: "è¾²æ¥­", d: ["å·¥æ¥­", "å•†æ¥­", "å»ºç¯‰"]},
                {q: "Accurate", a: "æ­£ç¢ºãª", d: ["è²´é‡ãª", "é©åˆ‡ãª", "è¤‡é›‘ãª"]},
                {q: "Commercial", a: "å•†æ¥­çš„ãª", d: ["å€‹äººçš„ãª", "æ”¿æ²»çš„ãª", "å­¦è¡“çš„ãª"]},
                {q: "Objective", a: "å®¢è¦³çš„ãª", d: ["ä¸»è¦³çš„ãª", "ä¼çµ±çš„ãª", "æ„Ÿæƒ…çš„ãª"]},
                {q: "Priority", a: "å„ªå…ˆäº‹é …", d: ["éå»", "èƒŒæ™¯", "å¨¯æ¥½"]},
                {q: "Welfare", a: "ç¦ç¥‰", d: ["å¯Œ", "æ•™è‚²", "å¨¯æ¥½"]}
            ]
        };

        let currentLevel = "æº–2ç´š";
        let shuffledQuestions = [];
        let currentIdx = 0, score = 0, combo = 0, maxCombo = 0;
        let timerInterval, timeLeft = 100, currentMistakes = [];

        // è‹¦æ‰‹åº¦ã¨å±¥æ­´ã®ç®¡ç†
        let stats = JSON.parse(localStorage.getItem('eiken_stats_v2') || '{}');

        window.onload = updateHistoryDisplay;

        function selectLevel(lvl, btn) {
            currentLevel = lvl;
            document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function startQuiz() {
            const baseWords = [...dictionary[currentLevel]];
            // è‹¦æ‰‹ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã‚‚ã®ã‚’å„ªå…ˆã—ã¤ã¤ã€20å•ã‚’æŠ½å‡º
            shuffledQuestions = baseWords.sort((a, b) => {
                const wA = stats[a.q] || 0;
                const wB = stats[b.q] || 0;
                return (Math.random() * 0.6 + wB) - (Math.random() * 0.6 + wA);
            }).slice(0, 20);

            showScreen('quiz-screen');
            currentIdx = 0; score = 0; combo = 0; maxCombo = 0; currentMistakes = [];
            loadQuestion();
        }

        function loadQuestion() {
            if (currentIdx >= shuffledQuestions.length) { saveResult(); showResult(); return; }
            
            const data = shuffledQuestions[currentIdx];
            document.getElementById('current-info').innerText = `${currentLevel} - ${currentIdx + 1} / ${shuffledQuestions.length}`;
            document.getElementById('q-word').innerText = data.q;
            
            // è‹¦æ‰‹ãƒãƒƒã‚¸è¡¨ç¤º
            const badgeEl = document.getElementById('target-badge');
            if ((stats[data.q] || 0) >= 2) {
                badgeEl.innerText = "è‹¦æ‰‹!";
                badgeEl.className = "badge";
            } else {
                badgeEl.innerText = "";
                badgeEl.className = "";
            }
            
            const opts = [data.a, ...data.d].sort(() => Math.random() - 0.5);
            const container = document.getElementById('options');
            container.innerHTML = '';
            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => checkAnswer(opt === data.a, btn, data);
                container.appendChild(btn);
            });
            startTimer();
            setTimeout(speak, 400);
        }

        function checkAnswer(isCorrect, btn, data) {
            clearInterval(timerInterval);
            document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
            const feedbackIcon = document.getElementById('feedback-icon');

            if (isCorrect) {
                btn.classList.add('correct');
                feedbackIcon.innerText = "â­•ï¸";
                feedbackIcon.style.color = "var(--apple-green)";
                score++; combo++;
                if(combo > maxCombo) maxCombo = combo;
                if (stats[data.q] > 0) stats[data.q]--; 
            } else {
                if(btn) btn.classList.add('wrong');
                feedbackIcon.innerText = "âŒ";
                feedbackIcon.style.color = "var(--apple-red)";
                combo = 0;
                currentMistakes.push(`${data.q} : ${data.a}`);
                stats[data.q] = (stats[data.q] || 0) + 2; // è‹¦æ‰‹ã‚¹ã‚³ã‚¢åŠ ç®—
                document.querySelectorAll('.opt-btn').forEach(b => { if(b.innerText === data.a) b.classList.add('correct'); });
            }
            
            localStorage.setItem('eiken_stats_v2', JSON.stringify(stats));
            document.getElementById('combo-display').innerText = `${combo} COMBO`;
            feedbackIcon.classList.add('show-feedback');
            setTimeout(() => { 
                feedbackIcon.classList.remove('show-feedback'); 
                currentIdx++; 
                loadQuestion(); 
            }, 1000);
        }

        function startTimer() {
            clearInterval(timerInterval);
            timeLeft = 100;
            timerInterval = setInterval(() => {
                timeLeft -= 2.0; 
                document.getElementById('timer').style.width = timeLeft + "%";
                if (timeLeft <= 0) { clearInterval(timerInterval); checkAnswer(false, null, shuffledQuestions[currentIdx]); }
            }, 100);
        }

        function speak() {
            const word = document.getElementById('q-word').innerText;
            const uttr = new SpeechSynthesisUtterance(word);
            const voices = speechSynthesis.getVoices();
            const preferred = voices.find(v => (v.name.includes('Samantha') || v.name.includes('Daniel')) && v.lang.includes('en'));
            if (preferred) uttr.voice = preferred;
            uttr.lang = 'en-US';
            uttr.rate = 0.85;
            speechSynthesis.cancel();
            speechSynthesis.speak(uttr);
        }

        function saveResult() {
            const history = JSON.parse(localStorage.getItem('eiken_history_v2') || '[]');
            const now = new Date();
            const dateStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
            history.unshift({ date: dateStr, level: currentLevel, score, total: shuffledQuestions.length });
            localStorage.setItem('eiken_history_v2', JSON.stringify(history.slice(0, 5)));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('eiken_history_v2') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = history.length ? history.map(i => `<div style="padding:5px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${i.date} [${i.level}]</span><b>${i.score}/${i.total}</b></div>`).join('') : 'å±¥æ­´ãªã—';
        }

        function showResult() {
            showScreen('result-screen');
            document.getElementById('final-score').innerText = `${score} / ${shuffledQuestions.length}`;
            document.getElementById('max-combo-info').innerText = `æœ€é«˜ã‚³ãƒ³ãƒœ: ${maxCombo}`;
            const mList = document.getElementById('mistake-list');
            mList.innerHTML = '<h3>ãƒŸã‚¹ã—ãŸå˜èª</h3>';
            if(currentMistakes.length === 0) mList.innerHTML += "<p>æº€ç‚¹ï¼ç´ æ™´ã‚‰ã—ã„ï¼</p>";
            currentMistakes.forEach(m => { const d = document.createElement('div'); d.innerText = "âŒ " + m; mList.appendChild(d); });
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goToHome() { showScreen('home-screen'); }
        speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
    </script>
</body>
</html>
